<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng t·ªïng h·ª£p thu chi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Adapter for date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jspdf-autotable CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 p-6">

    <div class="max-w-7xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">B·∫£ng t·ªïng h·ª£p thu chi</h1>

        <!-- B·ªô l·ªçc ng√†y v√† n√∫t t·∫£i l·∫°i -->
        <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-8 p-4 rounded-xl bg-gray-50">
            <div class="flex items-center space-x-2">
                <label for="startDate" class="text-sm font-medium text-gray-700">T·ª´ ng√†y:</label>
                <input type="date" id="startDate" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="endDate" class="text-sm font-medium text-gray-700">ƒê·∫øn ng√†y:</label>
                <input type="date" id="endDate" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="applyFilters" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out">
                √Åp d·ª•ng
            </button>
            <button id="reloadData" class="px-6 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg shadow-md hover:bg-gray-400 transition duration-150 ease-in-out">
                üîÑ T·∫£i l·∫°i d·ªØ li·ªáu
            </button>
            <button id="exportPdfBtn" class="px-6 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out">
                PDF
            </button>
            <button id="exportExcelBtn" class="px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out">
                Excel
            </button>
        </div>

        <div id="loading" class="text-center text-blue-600 font-semibold text-lg py-4 hidden">
            ‚è≥ ƒêang t·∫£i v√† x·ª≠ l√Ω d·ªØ li·ªáu...
        </div>

        <!-- C√°c th·∫ª t√≥m t·∫Øt s·ªë li·ªáu -->
        <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-indigo-100 p-6 rounded-2xl shadow-lg border-2 border-indigo-200">
                <div class="text-sm font-semibold text-indigo-700 mb-2">S·ªë d∆∞ ƒë·∫ßu k·ª≥</div>
                <div id="total-start-balance" class="text-2xl font-bold text-indigo-900">0 VND</div>
            </div>
            <div class="bg-green-100 p-6 rounded-2xl shadow-lg border-2 border-green-200">
                <div class="text-sm font-semibold text-green-700 mb-2">T·ªïng thu trong k·ª≥</div>
                <div id="total-income" class="text-2xl font-bold text-green-900">0 VND</div>
            </div>
            <div class="bg-red-100 p-6 rounded-2xl shadow-lg border-2 border-red-200">
                <div class="text-sm font-semibold text-red-700 mb-2">T·ªïng chi trong k·ª≥</div>
                <div id="total-expense" class="text-2xl font-bold text-red-900">0 VND</div>
            </div>
            <div class="bg-purple-100 p-6 rounded-2xl shadow-lg border-2 border-purple-200">
                <div class="text-sm font-semibold text-purple-700 mb-2">S·ªë d∆∞ cu·ªëi k·ª≥</div>
                <div id="total-end-balance" class="text-2xl font-bold text-purple-900">0 VND</div>
            </div>
        </div>
        
        <!-- B·∫£ng chi ti·∫øt s·ªë d∆∞ qu·ªπ -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4">S·ªë d∆∞ theo Qu·ªπ ti·ªÅn</h2>
        <div class="bg-gray-50 p-6 rounded-2xl shadow-lg mb-8 overflow-x-auto">
            <table class="w-full text-left whitespace-nowrap">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="px-4 py-2 font-medium text-gray-600 rounded-tl-xl">T√™n Qu·ªπ</th>
                        <th class="px-4 py-2 font-medium text-gray-600">S·ªë d∆∞ ƒë·∫ßu k·ª≥</th>
                        <th class="px-4 py-2 font-medium text-gray-600">Thu trong k·ª≥</th>
                        <th class="px-4 py-2 font-medium text-gray-600">Chi trong k·ª≥</th>
                        <th class="px-4 py-2 font-medium text-gray-600 rounded-tr-xl">S·ªë d∆∞ cu·ªëi k·ª≥</th>
                    </tr>
                </thead>
                <tbody id="fund-summary-table" class="divide-y divide-gray-200">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <!-- Bi·ªÉu ƒë·ªì -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-center">Thu - Chi theo ng√†y</h3>
                <canvas id="incomeExpenseOverTimeChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-center">T·ª∑ l·ªá Thu v√† Chi</h3>
                <canvas id="incomeExpensePieChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-center">T·ªïng Thu theo danh m·ª•c</h3>
                <canvas id="incomeByCategoryChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-center">T·ªïng Chi theo danh m·ª•c</h3>
                <canvas id="expenseByCategoryChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-center">S·ªë d∆∞ cu·ªëi k·ª≥ theo qu·ªπ</h3>
                <canvas id="fundEndBalanceChart"></canvas>
            </div>
        </div>
        
        <!-- B·∫£ng chi ti·∫øt giao d·ªãch -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Danh s√°ch giao d·ªãch trong k·ª≥</h2>
            <div class="bg-gray-50 p-6 rounded-2xl shadow-lg overflow-x-auto">
                <table class="w-full text-left whitespace-nowrap">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="px-4 py-2 font-medium text-gray-600 rounded-tl-xl">Ng√†y</th>
                            <th class="px-4 py-2 font-medium text-gray-600">Lo·∫°i</th>
                            <th class="px-4 py-2 font-medium text-gray-600">Di·ªÖn gi·∫£i</th>
                            <th class="px-4 py-2 font-medium text-gray-600">S·ªë ti·ªÅn</th>
                            <th class="px-4 py-2 font-medium text-gray-600">H√¨nh th·ª©c</th>
                            <th class="px-4 py-2 font-medium text-gray-600 rounded-tr-xl">Ng∆∞·ªùi t·∫°o</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list-table" class="divide-y divide-gray-200">
                        <!-- D·ªØ li·ªáu giao d·ªãch chi ti·∫øt s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // URLs c·ªßa Google Sheets (ƒë√£ ƒë∆∞·ª£c c√¥ng khai)
        const urls = {
            phieuthu: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWBBNDVSZoVKzZSGTcb8XUFk0tDWY8uJWATaxUDKUAm8GZfn4bkXV9N1xFTEkQFV966deIEfIqnGtc/pub?gid=0&single=true&output=csv",
            quytien: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWBBNDVSZoVKzZSGTcb8XUFk0tDWY8uJWATaxUDKUAm8GZfn4bkXV9N1xFTEkQFV966deIEfIqnGtc/pub?gid=884443899&single=true&output=csv"
        };

        // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu
        let rawData = {};
        let mappingQuy = {};
        let filteredTransactions = [];

        // C√°c bi·∫øn cho bi·ªÉu ƒë·ªì
        let chartInstances = {};

        // C√°c bi·∫øn cho DOM
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const reloadDataBtn = document.getElementById('reloadData');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const loadingEl = document.getElementById('loading');
        
        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        });

        // H√†m chuy·ªÉn ƒë·ªïi CSV th√†nh m·∫£ng d·ªØ li·ªáu
        function csvToArray(csvText) {
            return csvText.trim().split("\n").map(row => row.split(","));
        }

        // H√†m t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets
        async function preloadSheets() {
            loadingEl.classList.remove('hidden');
            rawData = {};
            mappingQuy = {};

            try {
                // T·∫£i d·ªØ li·ªáu t·ª´ c·∫£ hai sheets
                for (let key in urls) {
                    const res = await fetch(urls[key]);
                    const text = await res.text();
                    rawData[key] = csvToArray(text);
                }

                // X√¢y d·ª±ng √°nh x·∫° (mapping) t·ª´ ID Qu·ªπ sang T√™n Qu·ªπ
                const quytienRows = rawData["quytien"];
                if (quytienRows && quytienRows.length > 1) {
                    const headerQuy = quytienRows[0];
                    const idIndex = headerQuy.indexOf("ID");
                    const nameIndex = headerQuy.indexOf("T√™n qu·ªπ");
                    if (idIndex !== -1 && nameIndex !== -1) {
                        for (let i = 1; i < quytienRows.length; i++) {
                            const id = quytienRows[i][idIndex];
                            const name = quytienRows[i][nameIndex];
                            if (id && name) {
                                mappingQuy[id] = name;
                            }
                        }
                    }
                }
                
                // C√†i ƒë·∫∑t ng√†y m·∫∑c ƒë·ªãnh l√† ƒë·∫ßu th√°ng ƒë·∫øn cu·ªëi th√°ng hi·ªán t·∫°i
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                
                startDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
                endDateInput.value = lastDayOfMonth.toISOString().split('T')[0];

                updateDashboard();

            } catch (error) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
                loadingEl.textContent = "L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.";
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // H√†m ch√≠nh ƒë·ªÉ c·∫≠p nh·∫≠t to√†n b·ªô dashboard
        function updateDashboard() {
            if (!rawData.phieuthu || !rawData.quytien) {
                console.warn("D·ªØ li·ªáu ch∆∞a s·∫µn s√†ng.");
                return;
            }

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            endDate.setHours(23, 59, 59, 999); // ƒê·∫∑t ƒë·∫øn cu·ªëi ng√†y
            
            const phieuRows = rawData.phieuthu.slice(1);
            const headerPhieu = rawData.phieuthu[0];
            const dateIndex = headerPhieu.indexOf("Ng√†y");
            const incomeIndex = headerPhieu.indexOf("S·ªë ti·ªÅn thu");
            const expenseIndex = headerPhieu.indexOf("S·ªë ti·ªÅn chi");
            const incomeFundIndex = headerPhieu.indexOf("Qu·ªπ ƒë·∫øn");
            const expenseFundIndex = headerPhieu.indexOf("Qu·ªπ ƒëi");

            // Kh·ªüi t·∫°o c√°c ƒë·ªëi t∆∞·ª£ng ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu
            const initialBalances = {};
            const periodIncome = {};
            const periodExpense = {};
            const allFunds = new Set(Object.values(mappingQuy));
            allFunds.forEach(fundName => {
                initialBalances[fundName] = 0;
                periodIncome[fundName] = 0;
                periodExpense[fundName] = 0;
            });

            // L·∫∑p qua t·∫•t c·∫£ c√°c giao d·ªãch ƒë·ªÉ t√≠nh to√°n s·ªë d∆∞ ƒë·∫ßu k·ª≥ v√† thu chi trong k·ª≥
            filteredTransactions = [];
            phieuRows.forEach(row => {
                const transactionDate = new Date(row[dateIndex]);
                const income = parseFloat(row[incomeIndex]) || 0;
                const expense = parseFloat(row[expenseIndex]) || 0;
                const incomeFund = mappingQuy[row[incomeFundIndex]];
                const expenseFund = mappingQuy[row[expenseFundIndex]];
                
                if (transactionDate < startDate) {
                    // T√≠nh s·ªë d∆∞ ban ƒë·∫ßu cho t·ª´ng qu·ªπ d·ª±a tr√™n c√°c giao d·ªãch tr∆∞·ªõc th·ªùi gian l·ªçc
                    if (incomeFund) initialBalances[incomeFund] += income;
                    if (expenseFund) initialBalances[expenseFund] -= expense;
                } else if (transactionDate >= startDate && transactionDate <= endDate) {
                    // Thu th·∫≠p c√°c giao d·ªãch trong k·ª≥ ƒë·ªÉ hi·ªÉn th·ªã v√† t√≠nh to√°n
                    filteredTransactions.push(row);
                    
                    // T√≠nh t·ªïng thu v√† chi trong k·ª≥
                    if (incomeFund) periodIncome[incomeFund] += income;
                    if (expenseFund) periodExpense[expenseFund] += expense;
                }
            });

            // T√≠nh s·ªë d∆∞ cu·ªëi k·ª≥ v√† t·ªïng h·ª£p
            const totalSummary = {
                startBalance: 0,
                income: 0,
                expense: 0,
                endBalance: 0
            };
            const fundSummary = {};

            Object.keys(initialBalances).forEach(fundName => {
                const startBalance = initialBalances[fundName];
                const income = periodIncome[fundName] || 0;
                const expense = periodExpense[fundName] || 0;
                const endBalance = startBalance + income - expense;
                fundSummary[fundName] = { startBalance, income, expense, endBalance };

                totalSummary.startBalance += startBalance;
                totalSummary.income += income;
                totalSummary.expense += expense;
                totalSummary.endBalance += endBalance;
            });
            
            // C·∫≠p nh·∫≠t DOM
            document.getElementById('total-start-balance').textContent = formatter.format(totalSummary.startBalance);
            document.getElementById('total-income').textContent = formatter.format(totalSummary.income);
            document.getElementById('total-expense').textContent = formatter.format(totalSummary.expense);
            document.getElementById('total-end-balance').textContent = formatter.format(totalSummary.endBalance);

            // C·∫≠p nh·∫≠t b·∫£ng chi ti·∫øt qu·ªπ
            const tableBody = document.getElementById('fund-summary-table');
            tableBody.innerHTML = '';
            Object.keys(fundSummary).sort().forEach(fundName => {
                const fundData = fundSummary[fundName];
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2">${fundName}</td>
                    <td class="px-4 py-2">${formatter.format(fundData.startBalance)}</td>
                    <td class="px-4 py-2">${formatter.format(fundData.income)}</td>
                    <td class="px-4 py-2">${formatter.format(fundData.expense)}</td>
                    <td class="px-4 py-2 font-medium">${formatter.format(fundData.endBalance)}</td>
                `;
                tableBody.appendChild(row);
            });

            // L·∫•y d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
            const chartData = getChartData(filteredTransactions, headerPhieu);
            
            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
            renderIncomeExpenseOverTimeChart(chartData.dailyData);
            renderIncomeExpensePieChart(chartData.totalIncome, chartData.totalExpense);
            renderIncomeByCategoryChart(chartData.incomeByCat);
            renderExpenseByCategoryChart(chartData.expenseByCat);
            renderFundEndBalanceChart(fundSummary);

            // C·∫≠p nh·∫≠t b·∫£ng danh s√°ch giao d·ªãch chi ti·∫øt
            renderTransactionList(filteredTransactions, headerPhieu);
        }

        // H√†m render b·∫£ng chi ti·∫øt giao d·ªãch
        function renderTransactionList(transactions, header) {
            const tableBody = document.getElementById('transaction-list-table');
            tableBody.innerHTML = '';

            const dateIndex = header.indexOf("Ng√†y");
            const incomeIndex = header.indexOf("S·ªë ti·ªÅn thu");
            const expenseIndex = header.indexOf("S·ªë ti·ªÅn chi");
            const incomeContentIndex = header.indexOf("N·ªôi dung thu");
            const expenseContentIndex = header.indexOf("N·ªôi dung chi");
            const incomeFundIndex = header.indexOf("Qu·ªπ ƒë·∫øn");
            const expenseFundIndex = header.indexOf("Qu·ªπ ƒëi");

            transactions.forEach(row => {
                const date = row[dateIndex];
                const income = parseFloat(row[incomeIndex]) || 0;
                const expense = parseFloat(row[expenseIndex]) || 0;
                const type = income > 0 ? 'Thu' : 'Chi';
                const description = income > 0 ? row[incomeContentIndex] : row[expenseContentIndex];
                const amount = income > 0 ? income : expense;
                const fund = income > 0 ? mappingQuy[row[incomeFundIndex]] : mappingQuy[row[expenseFundIndex]];
                const creator = 'N/A'; // D·ªØ li·ªáu kh√¥ng c√≥ trong sheet

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition-colors duration-150';
                tr.innerHTML = `
                    <td class="px-4 py-2">${date}</td>
                    <td class="px-4 py-2">${type}</td>
                    <td class="px-4 py-2">${description}</td>
                    <td class="px-4 py-2">${formatter.format(amount)}</td>
                    <td class="px-4 py-2">${fund || ''}</td>
                    <td class="px-4 py-2">${creator}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // H√†m tr√≠ch xu·∫•t d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
        function getChartData(transactions, header) {
            const dateIndex = header.indexOf("Ng√†y");
            const incomeIndex = header.indexOf("S·ªë ti·ªÅn thu");
            const expenseIndex = header.indexOf("S·ªë ti·ªÅn chi");
            const incomeCatIndex = header.indexOf("Danh m·ª•c thu");
            const expenseCatIndex = header.indexOf("Danh m·ª•c chi");

            const dailyData = {};
            const incomeByCat = {};
            const expenseByCat = {};
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(row => {
                const date = row[dateIndex];
                const income = parseFloat(row[incomeIndex]) || 0;
                const expense = parseFloat(row[expenseIndex]) || 0;
                const incomeCat = row[incomeCatIndex];
                const expenseCat = row[expenseCatIndex];

                // D·ªØ li·ªáu theo ng√†y
                if (!dailyData[date]) {
                    dailyData[date] = { income: 0, expense: 0 };
                }
                dailyData[date].income += income;
                dailyData[date].expense += expense;

                // D·ªØ li·ªáu theo danh m·ª•c
                if (income > 0 && incomeCat) {
                    incomeByCat[incomeCat] = (incomeByCat[incomeCat] || 0) + income;
                }
                if (expense > 0 && expenseCat) {
                    expenseByCat[expenseCat] = (expenseByCat[expenseCat] || 0) + expense;
                }

                // T·ªïng thu chi
                totalIncome += income;
                totalExpense += expense;
            });
            
            return { dailyData, incomeByCat, expenseByCat, totalIncome, totalExpense };
        }

        // H√†m t·∫°o m√†u ng·∫´u nhi√™n cho bi·ªÉu ƒë·ªì
        function getRandomColor(alpha = 1) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu t·ªìn t·∫°i
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }
        
        // Render bi·ªÉu ƒë·ªì Thu Chi theo ng√†y
        function renderIncomeExpenseOverTimeChart(data) {
            destroyChart('incomeExpenseOverTimeChart');
            const dates = Object.keys(data).sort();
            const incomes = dates.map(date => data[date].income);
            const expenses = dates.map(date => data[date].expense);

            const ctx = document.getElementById('incomeExpenseOverTimeChart').getContext('2d');
            chartInstances.incomeExpenseOverTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'T·ªïng Thu',
                            data: incomes,
                            borderColor: 'rgba(52, 211, 153, 1)',
                            backgroundColor: 'rgba(52, 211, 153, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'T·ªïng Chi',
                            data: expenses,
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            title: { display: true, text: 'Ng√†y' }
                        },
                        y: {
                            title: { display: true, text: 'S·ªë ti·ªÅn (VND)' }
                        }
                    }
                }
            });
        }
        
        // Render bi·ªÉu ƒë·ªì tr√≤n t·ª∑ l·ªá Thu v√† Chi
        function renderIncomeExpensePieChart(income, expense) {
            destroyChart('incomeExpensePieChart');
            const ctx = document.getElementById('incomeExpensePieChart').getContext('2d');
            chartInstances.incomeExpensePieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['T·ªïng Thu', 'T·ªïng Chi'],
                    datasets: [{
                        data: [income, expense],
                        backgroundColor: ['rgba(52, 211, 153, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                        borderColor: ['#fff', '#fff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return `${label}: ${formatter.format(value)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render bi·ªÉu ƒë·ªì c·ªôt Thu theo danh m·ª•c
        function renderIncomeByCategoryChart(data) {
            destroyChart('incomeByCategoryChart');
            const labels = Object.keys(data);
            const values = Object.values(data);
            const bgColors = labels.map(() => getRandomColor(0.6));
            const borderColors = labels.map(() => getRandomColor(1));

            const ctx = document.getElementById('incomeByCategoryChart').getContext('2d');
            chartInstances.incomeByCategoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'T·ªïng thu',
                        data: values,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y', // Bi·ªÉu ƒë·ªì ngang
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.x || 0;
                                    return `${label}: ${formatter.format(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'S·ªë ti·ªÅn (VND)' }
                        },
                        y: {
                            title: { display: true, text: 'Danh m·ª•c' }
                        }
                    }
                }
            });
        }
        
        // Render bi·ªÉu ƒë·ªì c·ªôt Chi theo danh m·ª•c
        function renderExpenseByCategoryChart(data) {
            destroyChart('expenseByCategoryChart');
            const labels = Object.keys(data);
            const values = Object.values(data);
            const bgColors = labels.map(() => getRandomColor(0.6));
            const borderColors = labels.map(() => getRandomColor(1));

            const ctx = document.getElementById('expenseByCategoryChart').getContext('2d');
            chartInstances.expenseByCategoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'T·ªïng chi',
                        data: values,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y', // Bi·ªÉu ƒë·ªì ngang
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.x || 0;
                                    return `${label}: ${formatter.format(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'S·ªë ti·ªÅn (VND)' }
                        },
                        y: {
                            title: { display: true, text: 'Danh m·ª•c' }
                        }
                    }
                }
            });
        }

        // Render bi·ªÉu ƒë·ªì c·ªôt s·ªë d∆∞ cu·ªëi k·ª≥ theo qu·ªπ
        function renderFundEndBalanceChart(data) {
            destroyChart('fundEndBalanceChart');
            const labels = Object.keys(data);
            const values = labels.map(fundName => data[fundName].endBalance);
            const bgColors = values.map(value => value >= 0 ? 'rgba(52, 211, 153, 0.6)' : 'rgba(239, 68, 68, 0.6)');
            const borderColors = values.map(value => value >= 0 ? 'rgba(52, 211, 153, 1)' : 'rgba(239, 68, 68, 1)');

            const ctx = document.getElementById('fundEndBalanceChart').getContext('2d');
            chartInstances.fundEndBalanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë d∆∞ cu·ªëi k·ª≥',
                        data: values,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y || 0;
                                    return `${label}: ${formatter.format(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Qu·ªπ' }
                        },
                        y: {
                            title: { display: true, text: 'S·ªë d∆∞ (VND)' }
                        }
                    }
                }
            });
        }
        
        // H√†m xu·∫•t d·ªØ li·ªáu ra file PDF
        function exportToPdf() {
            if (!filteredTransactions.length) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
            doc.setFont('Roboto');

            const headers = [['Ng√†y', 'S·ªë ti·ªÅn thu', 'S·ªë ti·ªÅn chi', 'N·ªôi dung thu', 'N·ªôi dung chi', 'Qu·ªπ ƒë·∫øn', 'Qu·ªπ ƒëi']];
            const data = filteredTransactions.map(row => {
                const date = row[0];
                const income = parseFloat(row[1]) || 0;
                const expense = parseFloat(row[2]) || 0;
                const incomeContent = row[3];
                const expenseContent = row[4];
                const incomeFund = mappingQuy[row[5]] || '';
                const expenseFund = mappingQuy[row[6]] || '';

                return [
                    date,
                    formatter.format(income),
                    formatter.format(expense),
                    incomeContent,
                    expenseContent,
                    incomeFund,
                    expenseFund
                ];
            });

            doc.text("B√°o C√°o Thu Chi", 14, 20);
            doc.autoTable({
                startY: 30,
                head: headers,
                body: data,
                styles: { font: 'Roboto' }
            });

            doc.save("bao_cao_thu_chi.pdf");
        }

        // H√†m xu·∫•t d·ªØ li·ªáu ra file Excel (CSV)
        function exportToExcel() {
            if (!filteredTransactions.length) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
                return;
            }

            const header = ['"Ng√†y"', '"S·ªë ti·ªÅn thu"', '"S·ªë ti·ªÅn chi"', '"N·ªôi dung thu"', '"N·ªôi dung chi"', '"Qu·ªπ ƒë·∫øn"', '"Qu·ªπ ƒëi"'];
            
            const csvRows = filteredTransactions.map(row => {
                const date = `"${row[0]}"`;
                const income = `"${parseFloat(row[1]) || 0}"`;
                const expense = `"${parseFloat(row[2]) || 0}"`;
                const incomeContent = `"${row[3]}"`;
                const expenseContent = `"${row[4]}"`;
                const incomeFund = `"${mappingQuy[row[5]] || ''}"`;
                const expenseFund = `"${mappingQuy[row[6]] || ''}"`;
                
                return [date, income, expense, incomeContent, expenseContent, incomeFund, expenseFund].join(',');
            });
            
            const csvString = [
                header.join(','),
                ...csvRows
            ].join('\n');

            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'bao_cao_thu_chi.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Th√™m s·ª± ki·ªán cho n√∫t √Åp d·ª•ng v√† T·∫£i l·∫°i
        applyFiltersBtn.addEventListener('click', updateDashboard);
        reloadDataBtn.addEventListener('click', preloadSheets);
        exportPdfBtn.addEventListener('click', exportToPdf);
        exportExcelBtn.addEventListener('click', exportToExcel);

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
        preloadSheets();
    </script>

</body>
</html>
