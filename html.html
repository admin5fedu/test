<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Hi·ªÉn th·ªã nhi·ªÅu Sheet</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tabs { margin-bottom: 20px; }
    button { margin-right: 10px; padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #f7f7f7; }
    button:hover { background: #e6e6e6; }
    button.active { background: #007BFF; color: white; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Qu·∫£n l√Ω d·ªØ li·ªáu Google Sheet</h2>
  <div class="tabs">
    <button id="btn-phieuthu" onclick="showSheet('phieuthu')">Phi·∫øu thu chi</button>
    <button id="btn-quytien" onclick="showSheet('quytien')">Qu·ªπ ti·ªÅn</button>
    <button onclick="reloadData()">üîÑ T·∫£i l·∫°i</button>
  </div>

  <div id="table-container"></div>

  <script>
    // Link CSV c√°c sheet
    const urls = {
      phieuthu: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWBBNDVSZoVKzZSGTcb8XUFk0tDWY8uJWATaxUDKUAm8GZfn4bkXV9N1xFTEkQFV966deIEfIqnGtc/pub?gid=0&single=true&output=csv",
      quytien: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWBBNDVSZoVKzZSGTcb8XUFk0tDWY8uJWATaxUDKUAm8GZfn4bkXV9N1xFTEkQFV966deIEfIqnGtc/pub?gid=884443899&single=true&output=csv"
    };

    let cache = {};       // Cache b·∫£ng HTML
    let rawData = {};     // Cache d·ªØ li·ªáu th√¥ (m·∫£ng)
    let mappingQuy = {};  // B·∫£n ƒë·ªì ID ‚Üí T√™n qu·ªπ

    // T·∫£i tr∆∞·ªõc to√†n b·ªô sheet
    async function preloadSheets() {
      cache = {};
      rawData = {};
      mappingQuy = {};

      for (let key in urls) {
        const res = await fetch(urls[key]);
        const text = await res.text();
        rawData[key] = csvToArray(text);
      }

      // T·∫°o mapping ID ‚Üí T√™n qu·ªπ t·ª´ sheet "Qu·ªπ ti·ªÅn"
      const quytienRows = rawData["quytien"];
      const headerQuy = quytienRows[0];
      const idIndex = headerQuy.indexOf("ID");
      const nameIndex = headerQuy.indexOf("T√™n qu·ªπ");
      if (idIndex !== -1 && nameIndex !== -1) {
        for (let i = 1; i < quytienRows.length; i++) {
          const row = quytienRows[i];
          mappingQuy[row[idIndex]] = row[nameIndex];
        }
      }

      // X·ª≠ l√Ω b·∫£ng Phi·∫øu thu chi: thay ID b·∫±ng t√™n qu·ªπ
      const phieuRows = rawData["phieuthu"];
      const headerPhieu = phieuRows[0];
      const quyDenIndex = headerPhieu.indexOf("Qu·ªπ ƒë·∫øn");
      const quyDiIndex = headerPhieu.indexOf("Qu·ªπ ƒëi");

      if (quyDenIndex !== -1 || quyDiIndex !== -1) {
        for (let i = 1; i < phieuRows.length; i++) {
          if (quyDenIndex !== -1) {
            const id = phieuRows[i][quyDenIndex];
            if (mappingQuy[id]) phieuRows[i][quyDenIndex] = mappingQuy[id];
          }
          if (quyDiIndex !== -1) {
            const id = phieuRows[i][quyDiIndex];
            if (mappingQuy[id]) phieuRows[i][quyDiIndex] = mappingQuy[id];
          }
        }
      }

      // T·∫°o b·∫£ng HTML t·ª´ d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω
      cache["phieuthu"] = arrayToTable(phieuRows);
      cache["quytien"] = arrayToTable(quytienRows);

      showSheet("phieuthu");
    }

    // Reload d·ªØ li·ªáu
    function reloadData() {
      document.getElementById("table-container").innerHTML = "‚è≥ ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...";
      preloadSheets();
    }

    // Chuy·ªÉn tab sheet
    function showSheet(name) {
      document.querySelectorAll(".tabs button").forEach(btn => btn.classList.remove("active"));
      const activeBtn = document.getElementById("btn-" + name);
      if (activeBtn) activeBtn.classList.add("active");

      const container = document.getElementById("table-container");
      container.innerHTML = "";
      container.appendChild(cache[name]);
    }

    // CSV ‚Üí Array
    function csvToArray(csvText) {
      return csvText.trim().split("\n").map(r => r.split(","));
    }

    // Array ‚Üí B·∫£ng HTML
    function arrayToTable(rows) {
      const table = document.createElement("table");
      rows.forEach((row, i) => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement(i === 0 ? "th" : "td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      return table;
    }

    preloadSheets();
  </script>
</body>
</html>
