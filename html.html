<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Hi·ªÉn th·ªã nhi·ªÅu Sheet c√≥ ph√¢n trang</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tabs { margin-bottom: 20px; }
    button { margin-right: 10px; padding: 6px 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #f7f7f7; }
    button:hover { background: #e6e6e6; }
    button.active { background: #007BFF; color: white; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #f2f2f2; }
    .pagination { margin-top: 15px; }
  </style>
</head>
<body>
  <h2>Qu·∫£n l√Ω d·ªØ li·ªáu Google Sheet</h2>
  <div class="tabs">
    <button id="btn-phieuthu" onclick="showSheet('phieuthu')">Phi·∫øu thu chi</button>
    <button id="btn-quytien" onclick="showSheet('quytien')">Qu·ªπ ti·ªÅn</button>
    <button onclick="reloadData()">üîÑ T·∫£i l·∫°i</button>
  </div>

  <div id="table-container"></div>
  <div class="pagination" id="pagination"></div>

  <script>
    const urls = {
      phieuthu: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWBBNDVSZoVKzZSGTcb8XUFk0tDWY8uJWATaxUDKUAm8GZfn4bkXV9N1xFTEkQFV966deIEfIqnGtc/pub?gid=0&single=true&output=csv",
      quytien: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWBBNDVSZoVKzZSGTcb8XUFk0tDWY8uJWATaxUDKUAm8GZfn4bkXV9N1xFTEkQFV966deIEfIqnGtc/pub?gid=884443899&single=true&output=csv"
    };

    let rawData = {};
    let mappingQuy = {};
    let currentSheet = "phieuthu";
    let currentPage = 1;
    const rowsPerPage = 20;

    async function preloadSheets() {
      rawData = {};
      mappingQuy = {};

      for (let key in urls) {
        const res = await fetch(urls[key]);
        const text = await res.text();
        rawData[key] = csvToArray(text);
      }

      // mapping qu·ªπ
      const quytienRows = rawData["quytien"];
      const headerQuy = quytienRows[0];
      const idIndex = headerQuy.indexOf("ID");
      const nameIndex = headerQuy.indexOf("T√™n qu·ªπ");
      if (idIndex !== -1 && nameIndex !== -1) {
        for (let i = 1; i < quytienRows.length; i++) {
          mappingQuy[quytienRows[i][idIndex]] = quytienRows[i][nameIndex];
        }
      }

      // x·ª≠ l√Ω phi·∫øu thu chi
      const phieuRows = rawData["phieuthu"];
      const headerPhieu = phieuRows[0];
      const quyDenIndex = headerPhieu.indexOf("Qu·ªπ ƒë·∫øn");
      const quyDiIndex = headerPhieu.indexOf("Qu·ªπ ƒëi");

      for (let i = 1; i < phieuRows.length; i++) {
        if (quyDenIndex !== -1) {
          const id = phieuRows[i][quyDenIndex];
          if (mappingQuy[id]) phieuRows[i][quyDenIndex] = mappingQuy[id];
        }
        if (quyDiIndex !== -1) {
          const id = phieuRows[i][quyDiIndex];
          if (mappingQuy[id]) phieuRows[i][quyDiIndex] = mappingQuy[id];
        }
      }

      showSheet("phieuthu");
    }

    function reloadData() {
      document.getElementById("table-container").innerHTML = "‚è≥ ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...";
      document.getElementById("pagination").innerHTML = "";
      preloadSheets();
    }

    function showSheet(name) {
      currentSheet = name;
      currentPage = 1;
      document.querySelectorAll(".tabs button").forEach(btn => btn.classList.remove("active"));
      const activeBtn = document.getElementById("btn-" + name);
      if (activeBtn) activeBtn.classList.add("active");
      renderPage();
    }

    function renderPage() {
      const container = document.getElementById("table-container");
      const pagination = document.getElementById("pagination");
      container.innerHTML = "";
      pagination.innerHTML = "";

      const rows = rawData[currentSheet];
      if (!rows) return;

      const header = rows[0];
      let dataRows = rows.slice(1);

      // ƒë·∫£o ng∆∞·ª£c: m·ªõi nh·∫•t l√™n tr∆∞·ªõc
      dataRows = dataRows.reverse();

      // ph√¢n trang
      const totalPages = Math.ceil(dataRows.length / rowsPerPage);
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageRows = dataRows.slice(start, end);

      const table = document.createElement("table");

      // th√™m header
      const trHead = document.createElement("tr");
      header.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      table.appendChild(trHead);

      // th√™m d·ªØ li·ªáu
      pageRows.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });

      container.appendChild(table);

      // ph√¢n trang controls
      if (totalPages > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "‚¨Ö Trang tr∆∞·ªõc";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { currentPage--; renderPage(); };

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Trang sau ‚û°";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => { currentPage++; renderPage(); };

        pagination.appendChild(prevBtn);
        pagination.appendChild(document.createTextNode(` Trang ${currentPage}/${totalPages} `));
        pagination.appendChild(nextBtn);
      }
    }

    function csvToArray(csvText) {
      return csvText.trim().split("\n").map(r => r.split(","));
    }

    preloadSheets();
  </script>
</body>
</html>
